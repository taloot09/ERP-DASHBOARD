{% extends 'base.html' %}
{% block main_content %}
{% load custom_filters %}
<div class="container">
    <h2 class="text-center">Manage Product</h2>
    <form method="POST">
        {% csrf_token %}
        <table class="table">
            <thead>
                <tr>
                    <th>Product ID</th>
                    <th>Product Name</th>
                    <th>Available Stock</th>
                    <th>Purchase Price</th>
                    <th>Average Purchase Price</th>
                    <th>Retail Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr>
                    <td>{{ product.id }}</td>
                    <td>
                        <input type="text" name="product_name_{{ product.id }}" value="{{ product.product_name }}">
                    </td>
                    <td>
                        <input type="number" name="quantity_{{ product.id }}" value="{{ product.quantity }}">
                    </td>
                    <td><input type="number" name="purchase_price{{ product.id }}" value="{{ product.purchase_price }}"></td>
                    <td>{{ average_prices|get_item:product.id }}</td>
                    <td>
                        <input type="text" name="retail_price_{{ product.id }}" value="{{ product.retail_price }}">
                    </td>
                    <td>
                        <button type="submit" name="update_product" value="{{ product.id }}" class="btn btn-primary">Save</button>
                        <!-- <a href="#" class="btn btn-info">View</a> -->
                        <a href="#" class="btn btn-danger">Delete</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
</div>

<script>
    document.querySelectorAll('.btn-primary').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            const row = this.closest('tr');
            const productId = this.value;
            const productName = row.querySelector(`input[name="product_name_${productId}"]`).value;
            const quantity = row.querySelector(`input[name="quantity_${productId}"]`).value;
            const retailPrice = row.querySelector(`input[name="retail_price_${productId}"]`).value;
    
            fetch(`/update-product/${productId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    product_name: productName,
                    quantity: quantity,
                    retail_price: retailPrice
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Product updated successfully!');
                } else {
                    alert('Error updating product.');
                }
            });
        });
    });
    </script>
{% endblock %}